-- Load OrionLib
local OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Orion/main/source"))()

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local UIS = game:GetService("UserInputService")

local Player = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- UI
local Window = OrionLib:MakeWindow({
    Name = "üå≤ 99 Nights in the Forest üåô",
    HidePremium = false,
    SaveConfig = true,
    ConfigFolder = "NightsConfig"
})

OrionLib:MakeNotification({
    Name = "Logged In!",
    Content = "Welcome " .. Player.Name .. "!",
    Image = "rbxassetid://4483345998",
    Time = 5
})

-- ========== STATE VARIABLES ==========
local FullBrightOn = false
local NoFogOn = false
local ESP_Toggles = {
    Deer = false,
    Player = false,
    Bunny = false,
    Wolf = false,
    Scrap = false
}
local ESP_Objects = {}

-- ========== MAIN TAB ==========
local MainTab = Window:MakeTab({ Name = "Main", Icon = "rbxassetid://4483345998", PremiumOnly = false })

MainTab:AddTextbox({
    Name = "üèÉ WalkSpeed",
    Default = "16",
    TextDisappear = true,
    Callback = function(Value)
        local h = Player.Character and Player.Character:FindFirstChildOfClass("Humanoid")
        if h then h.WalkSpeed = tonumber(Value) or 16 end
    end
})

MainTab:AddTextbox({
    Name = "ü¶ò JumpPower",
    Default = "50",
    TextDisappear = true,
    Callback = function(Value)
        local h = Player.Character and Player.Character:FindFirstChildOfClass("Humanoid")
        if h then h.JumpPower = tonumber(Value) or 50 end
    end
})

MainTab:AddToggle({
    Name = "üå´Ô∏è No Fog",
    Default = false,
    Callback = function(val) NoFogOn = val end
})

MainTab:AddToggle({
    Name = "üí° FullBright",
    Default = false,
    Callback = function(val) FullBrightOn = val end
})

-- Auto apply fog/fullbright every 0.1s
task.spawn(function()
    while true do
        task.wait(0.1)
        if FullBrightOn then
            Lighting.Brightness = 2
            Lighting.ClockTime = 12
            Lighting.FogEnd = 1e10
            Lighting.GlobalShadows = false
            Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
        end
        if NoFogOn then
            Lighting.FogEnd = 1e10
        end
    end
end)

-- ========== FLY MODE ==========
local flying = false
local flyConnection

local function startFlying()
    local char = Player.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local bg = Instance.new("BodyGyro", root)
    bg.P = 9e4
    bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.CFrame = root.CFrame

    local bv = Instance.new("BodyVelocity", root)
    bv.velocity = Vector3.zero
    bv.maxForce = Vector3.new(9e9, 9e9, 9e9)

    flyConnection = RunService.RenderStepped:Connect(function()
        local camCF = Camera.CFrame
        local dir = Vector3.zero

        if UIS:IsKeyDown(Enum.KeyCode.W) then dir += camCF.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.S) then dir -= camCF.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.A) then dir -= camCF.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.D) then dir += camCF.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.Space) then dir += Vector3.yAxis end
        if UIS:IsKeyDown(Enum.KeyCode.LeftControl) then dir -= Vector3.yAxis end

        bv.Velocity = dir.Magnitude > 0 and dir.Unit * 80 or Vector3.zero
        bg.CFrame = camCF
    end)
end

local function stopFlying()
    local root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    if flyConnection then flyConnection:Disconnect() end
    if root then
        for _, obj in ipairs(root:GetChildren()) do
            if obj:IsA("BodyGyro") or obj:IsA("BodyVelocity") then obj:Destroy() end
        end
    end
end

MainTab:AddToggle({
    Name = "üïäÔ∏è Fly Mode",
    Default = false,
    Callback = function(state)
        flying = state
        if flying then startFlying() else stopFlying() end
    end
})

-- ========== ESP ==========
local function createESP(part, color)
    if not part or part:FindFirstChild("ESP") then return end
    local box = Instance.new("BoxHandleAdornment", part)
    box.Name = "ESP"
    box.Size = part.Size + Vector3.new(0.1, 0.1, 0.1)
    box.Adornee = part
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Color3 = color
    box.Transparency = 0.5
end

local function clearAllESP()
    for _, v in ipairs(ESP_Objects) do
        if v and v:FindFirstChild("ESP") then v.ESP:Destroy() end
    end
    ESP_Objects = {}
end

local function scanForESP()
    clearAllESP()

    -- Deer (workspace.Characters)
    if ESP_Toggles.Deer then
        for _, char in pairs(Workspace:FindFirstChild("Characters"):GetChildren()) do
            if char:IsA("Model") and char:FindFirstChild("HumanoidRootPart") then
                createESP(char.HumanoidRootPart, Color3.new(1, 0, 0)) -- Red
                table.insert(ESP_Objects, char.HumanoidRootPart)
            end
        end
    end

    -- Bunny (workspace.Characters.Bunny)
    if ESP_Toggles.Bunny then
        local bunnyFolder = Workspace:FindFirstChild("Characters") and Workspace.Characters:FindFirstChild("Bunny")
        if bunnyFolder then
            for _, b in pairs(bunnyFolder:GetChildren()) do
                if b:IsA("Model") and b:FindFirstChild("HumanoidRootPart") then
                    createESP(b.HumanoidRootPart, Color3.new(1, 0.5, 0)) -- Orange
                    table.insert(ESP_Objects, b.HumanoidRootPart)
                end
            end
        end
    end

    -- Wolf (workspace.Characters.Wolf)
    if ESP_Toggles.Wolf then
        local wolfFolder = Workspace:FindFirstChild("Characters") and Workspace.Characters:FindFirstChild("Wolf")
        if wolfFolder then
            for _, w in pairs(wolfFolder:GetChildren()) do
                if w:IsA("Model") and w:FindFirstChild("HumanoidRootPart") then
                    createESP(w.HumanoidRootPart, Color3.new(0.5, 0, 1)) -- Purple
                    table.insert(ESP_Objects, w.HumanoidRootPart)
                end
            end
        end
    end

    -- Player ESP
    if ESP_Toggles.Player then
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= Player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                createESP(p.Character.HumanoidRootPart, Color3.new(0, 0, 1)) -- Blue
                table.insert(ESP_Objects, p.Character.HumanoidRootPart)
            end
        end
    end
end

-- ESP Tab
local ESPTab = Window:MakeTab({ Name = "üß† ESP", Icon = "rbxassetid://7350979880", PremiumOnly = false })

ESPTab:AddToggle({
    Name = "üî¥ Deer Monster ESP",
    Default = false,
    Callback = function(state) ESP_Toggles.Deer = state end
})
ESPTab:AddToggle({
    Name = "üîµ Player ESP",
    Default = false,
    Callback = function(state) ESP_Toggles.Player = state end
})
ESPTab:AddToggle({
    Name = "üü† Rabbits ESP",
    Default = false,
    Callback = function(state) ESP_Toggles.Bunny = state end
})
ESPTab:AddToggle({
    Name = "üü£ Wolves ESP",
    Default = false,
    Callback = function(state) ESP_Toggles.Wolf = state end
})
ESPTab:AddToggle({
    Name = "üü¢ Scraps ESP (soon)",
    Default = false,
    Callback = function(state) ESP_Toggles.Scrap = state end
})

-- Auto-update ESP every 0.5s
task.spawn(function()
    while true do
        task.wait(0.5)
        scanForESP()
    end
end)
